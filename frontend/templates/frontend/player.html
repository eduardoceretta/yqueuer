{% extends 'frontend/base.html' %}
{% load static %}

{% block body_block %}
  <script src="{% static "javascript/dev_jquery-3.1.1.js" %}"></script>

  <div id="player"></div>

  <button onclick="Skip()">Skip</button>
  <button onclick="End()">End</button>
  <div id="list"></div>

  <script type="text/javascript">

    function log() {
      console.log('_Y_',arguments);
    }

    class YQ_Player {
      constructor (div_id, w, h, videos, opts) {
        this.m_div_id = div_id;
        this.m_w = w;
        this.m_h = h;
        this.m_cur_index = 0;
        this.m_store_watched_cb = opts.store_watched;

        this.m_videos_dataset = videos;
        this.m_videos_ids = videos.map(function(e) {return e.id});

        this.m_player = new YT.Player(this.m_div_id, {
            height: this.m_h,
            width: this.m_w,
            events: {
              'onReady': this._onPlayerReady.bind(this),
              'onStateChange': this._onPlayerStateChange.bind(this)
            }
        });
        log ('new', div_id, w, h, opts, this);
      }

      _onPlayerReady(event) {
        this.m_player.mute();
        this.m_player.loadPlaylist(this.m_videos_ids.slice(0, this.m_cur_index+1), this.m_cur_index);
      }

      _onPlayerStateChange(event) {
        var playerStatus = event.data;
        var state;
        var vdata = this.m_player.getVideoData();

        if (playerStatus == -1) {
          // state = 'unstarted'
        } else if (playerStatus == 0) {
          state = 'ended'
          this.endVideo();

          // log(this.m_videos_ids.slice(0, this.m_cur_index+1), this.m_cur_index);
        } else if (playerStatus == 1) {
          // state = 'playing'
        } else if (playerStatus == 2) {
          // state = 'paused'
        } else if (playerStatus == 3) {
          // state = 'buffering'
        } else if (playerStatus == 5) {
          // state = 'cued'
        } else {
          // state = '_else_';
        }
        // log (state, this.m_player.getPlaylistIndex(), vdata.title, vdata.author, vdata.video_id, this.m_videos_ids);
      }

      _playNextVideo() {
        var vdata = this.m_player.getVideoData();
        this.m_cur_index++;
        this.m_player.loadPlaylist(this.m_videos_ids.slice(0, this.m_cur_index+1), this.m_cur_index);
      }

      _storeWatched() {
        var vdata = this.m_player.getVideoData();
        this.m_store_watched_cb(vdata.video_id);
      }

      skipVideo() {
        this._playNextVideo();
      }

      endVideo() {
        this._storeWatched();
        this._playNextVideo();
      }
    }

    var player;
    var videos = [];

    function FetchVideos(success_cb, error_cb) {
      log('FetchVideos');
      $.ajax({
        method: "POST",
        url: "/api/get_videos/",
        headers: {'X-CSRFToken': '{{ csrf_token }}'},
        data: { },
        success:  function(result){
          log('FetchVideos','success', result);
          videos = result.data.videos;
          if (success_cb)
            success_cb();
        },
        error: function(xhr,status,error){
          log('FetchVideos','error', xhr,status,error);
          if (error_cb)
            error_cb();
        }
      });
    }

    function InitPlayer() {
      log("InitPlayer");
      var tag = document.createElement('script');
      tag.id = 'iframe-demo';
      tag.src = 'https://www.youtube.com/iframe_api';
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    }

    function onYouTubeIframeAPIReady() {
      log("YT API READY");
      player = new YQ_Player(
          'player',
          1280, 720,
          videos,
          {'store_watched': storeWatchedCb}
      );
    }

    function Skip() {
      player.skipVideo();
    }

    function End() {
      player.endVideo();
    }

    function storeWatchedCb(vid_id) {
      console.log('storeWatchedCb', vid_id);
      $.ajax({
        method: "POST",
        url: "/api/mark_watched/",
        headers: {'X-CSRFToken': '{{ csrf_token }}'},
        data: { y_video_id : vid_id },
        success: function(result){
          log('storeWatchedCb','success', result);
        },
        error: function(xhr,status,error){
          log('storeWatchedCb','error', xhr,status,error);
        }
      });
    }

    function InitList() {
      log("InitList");
      var div_list = document.getElementById('list');

      var list = document.createElement('ul');

      for(var i = 0; i < videos.length; i++) {
          // Create the list item:
          var item = document.createElement('li');

          // Set its contents:
          item.appendChild(document.createTextNode(videos[i].channel_name + " - " + videos[i].title));

          // Add it to the list:
          list.appendChild(item);
      }

      div_list.appendChild(list);
    }

    FetchVideos(function(){InitPlayer();InitList();});

  </script>
{% endblock %}